"use client";

import * as React from "react";

type ViewMode = "my" | "ward";

type MeResponse = {
  staff: { id: string; org_id: string; display_name: string };
  wards: Array<{ ward_id: string; primary_ward: boolean | null }>;
};

type ShiftRow = {
  role_in_shift: "senior" | "junior" | "nurse_aid" | "admin" | string | null;

  shift_instance_id: string;
  shift_date: string; // YYYY-MM-DD
  ward_id: string;

  shift_name: string | null;
  shift_code: "morning" | "evening" | "night" | "ot" | string | null;

  start_time: string | null; // "08:00:00"
  end_time: string | null; // "16:00:00"
  cross_midnight: boolean | null;

  risk_flag: boolean | null;
  note: string | null;
};

function cx(...classes: Array<string | false | null | undefined>) {
  return classes.filter(Boolean).join(" ");
}

function todayISO() {
  const dt = new Date();
  const y = dt.getFullYear();
  const m = String(dt.getMonth() + 1).padStart(2, "0");
  const d = String(dt.getDate()).padStart(2, "0");
  return `${y}-${m}-${d}`;
}

function formatDateTH(yyyyMmDd: string) {
  const [y, m, d] = yyyyMmDd.split("-").map((n) => Number(n));
  const dt = new Date(y, m - 1, d);
  return dt.toLocaleDateString("th-TH", { weekday: "short", day: "2-digit", month: "short" });
}

function hhmm(t: string | null) {
  if (!t) return "--:--";
  return t.slice(0, 5);
}

function timeRange(start: string | null, end: string | null, crossMidnight?: boolean | null) {
  const s = hhmm(start);
  const e = hhmm(end);
  return crossMidnight ? `${s}‚Äì${e} (+1)` : `${s}‚Äì${e}`;
}

function shiftLabel(row: ShiftRow) {
  const code = row.shift_code ?? "";
  const map: Record<string, string> = { morning: "Morning", evening: "Evening", night: "Night", ot: "OT" };
  return row.shift_name ?? map[code] ?? "Shift";
}

function roleChip(role?: string | null) {
  if (!role) return null;
  const map: Record<string, string> = { senior: "Senior", junior: "Junior", nurse_aid: "Aide", admin: "Admin" };
  return map[role] ?? role;
}

function StatusBadge({ risk }: { risk: boolean }) {
  return (
    <span
      className={cx(
        "inline-flex items-center rounded-full px-2 py-0.5 text-xs ring-1 ring-inset",
        risk ? "bg-rose-50 text-rose-700 ring-rose-200" : "bg-zinc-100 text-zinc-700 ring-zinc-200"
      )}
    >
      {risk ? "‚ö†Ô∏è Risk" : "OK"}
    </span>
  );
}

function BottomSheet({
  open,
  title,
  children,
  onClose,
}: {
  open: boolean;
  title: string;
  children: React.ReactNode;
  onClose: () => void;
}) {
  if (!open) return null;

  return (
    <div className="fixed inset-0 z-50">
      <div
        onClick={onClose}
        className="absolute inset-0 bg-black/40"
        role="button"
        tabIndex={0}
        aria-label="Close overlay"
      />

      <div className="absolute bottom-0 left-0 right-0 max-h-[85dvh] overflow-hidden rounded-t-3xl bg-white shadow-2xl">
        <div className="flex items-center justify-between border-b border-zinc-200 px-5 py-4">
          <div className="text-base font-semibold text-zinc-900">{title}</div>
          <button
            onClick={onClose}
            className="rounded-full px-3 py-1.5 text-sm text-zinc-700 ring-1 ring-inset ring-zinc-200 hover:bg-zinc-50"
          >
            Close
          </button>
        </div>
        <div className="overflow-auto px-5 py-4">{children}</div>
      </div>
    </div>
  );
}

async function fetchJSON<T>(url: string): Promise<T> {
  const res = await fetch(url, { credentials: "include" });
  if (!res.ok) {
    const msg = await res.text();
    throw new Error(msg || `Request failed: ${res.status}`);
  }
  return res.json() as Promise<T>;
}

export default function StaffMobilePage() {
  const [mode, setMode] = React.useState<ViewMode>("my"); // demo: focus my
  const [me, setMe] = React.useState<MeResponse | null>(null);
  const [wardId, setWardId] = React.useState<string | null>(null);

  const [rows, setRows] = React.useState<ShiftRow[]>([]);
  const [loading, setLoading] = React.useState(true);
  const [err, setErr] = React.useState<string | null>(null);

  const [activeId, setActiveId] = React.useState<string | null>(null);
  const [sheetOpen, setSheetOpen] = React.useState(false);

  const from = React.useMemo(() => todayISO(), []);
  const limit = 14;

  // Load /me once
  React.useEffect(() => {
    let cancelled = false;
    (async () => {
      try {
        setErr(null);
        const data = await fetchJSON<MeResponse>("/api/m/me");
        if (cancelled) return;
        setMe(data);

        const primary = data.wards.find((w) => w.primary_ward) ?? data.wards[0];
        setWardId(primary?.ward_id ?? null);
      } catch {
        if (cancelled) return;
        setErr("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏≠‡∏≤‡∏à‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà login ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ staff record)");
      }
    })();
    return () => {
      cancelled = true;
    };
  }, []);

  // Load shifts (My only for demo)
  React.useEffect(() => {
    if (!me) return;
    let cancelled = false;

    (async () => {
      try {
        setLoading(true);
        setErr(null);

        const qs = new URLSearchParams();
        qs.set("from", from);
        qs.set("limit", String(limit));

        // demo: Ward mode ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡∏à‡∏∞‡∏ó‡∏≥ endpoint ‡πÅ‡∏¢‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
        // if (mode === "ward" && wardId) qs.set("wardId", wardId);

        const out = await fetchJSON<{ data: ShiftRow[] }>(`/api/m/shifts?${qs.toString()}`);
        if (cancelled) return;

        setRows(out.data ?? []);
      } catch {
        if (cancelled) return;
        setErr("‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πá‡∏Ñ API / RLS / mapping staff.user_id)");
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();

    return () => {
      cancelled = true;
    };
  }, [me, mode, wardId, from]);

  const upcoming = React.useMemo(() => {
    return [...rows]
      .sort((a, b) => {
        const d = a.shift_date.localeCompare(b.shift_date);
        if (d !== 0) return d;
        return (a.start_time ?? "").localeCompare(b.start_time ?? "");
      })
      .slice(0, 14);
  }, [rows]);

  const todayRow = React.useMemo(() => {
    const t = todayISO();
    return upcoming.find((r) => r.shift_date === t) ?? null;
  }, [upcoming]);

  const active = React.useMemo(() => {
    return rows.find((r) => r.shift_instance_id === activeId) ?? null;
  }, [rows, activeId]);

  function openDetails(id: string) {
    setActiveId(id);
    setSheetOpen(true);
  }

  function myRoleInShift(row: ShiftRow) {
    return row.role_in_shift ?? null;
  }

  async function logout() {
    try {
      await fetch("/api/auth/logout", { method: "POST" });
    } finally {
      window.location.href = "/login";
    }
  }

  const staffName = me?.staff.display_name ?? "‚Äî";

  return (
    // ‚úÖ KEY: ‡∏õ‡∏¥‡∏î window scroll + ‡∏ó‡∏≥‡πÉ‡∏´‡πâ scroll ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô <main> ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏•‡∏î URL bar ‡πÄ‡∏î‡πâ‡∏á‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
    <div
      className="flex h-[100dvh] flex-col overflow-hidden bg-zinc-50"
      style={{ paddingTop: "env(safe-area-inset-top)" }}
    >
      {/* Header (‡∏ô‡∏¥‡πà‡∏á) */}
      <div className="flex-none border-b border-zinc-200 bg-white/90 backdrop-blur">
        <div className="mx-auto max-w-md px-5 py-4">
          <div className="flex items-center justify-between">
            <div>
              <div className="text-xs text-zinc-500">Staff</div>
              <div className="text-lg font-semibold text-zinc-900">{mode === "my" ? "My Shifts" : "Ward Shifts"}</div>
            </div>
            <div className="text-right">
              <div className="text-xs text-zinc-500">Logged in</div>
              <div className="text-sm font-medium text-zinc-900">{staffName}</div>
            </div>
          </div>

          {/* Toggle */}
          <div className="mt-3 grid grid-cols-2 gap-2 rounded-2xl bg-zinc-100 p-1">
            <button
              onClick={() => setMode("my")}
              className={cx(
                "rounded-2xl px-4 py-2.5 text-sm font-semibold",
                mode === "my" ? "bg-white text-zinc-900 shadow-sm" : "text-zinc-600"
              )}
            >
              üë§ My
            </button>

            <button
              onClick={() => setMode("ward")}
              className={cx(
                "rounded-2xl px-4 py-2.5 text-sm font-semibold",
                mode === "ward" ? "bg-white text-zinc-900 shadow-sm" : "text-zinc-600"
              )}
              disabled={true}
              title="Demo ‡∏ô‡∏µ‡πâ‡πÇ‡∏ü‡∏Å‡∏±‡∏™ My ‡∏Å‡πà‡∏≠‡∏ô (Ward mode ‡∏à‡∏∞‡∏ó‡∏≥ endpoint ‡πÅ‡∏¢‡∏Å‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)"
            >
              üè• Ward
            </button>
          </div>

          {/* Ward selector (kept for future, but hidden because ward mode disabled) */}
          {mode === "ward" && (
            <div className="mt-3">
              <div className="text-xs text-zinc-500">Select ward</div>
              <select
                value={wardId ?? ""}
                onChange={(e) => setWardId(e.target.value)}
                className="mt-1 w-full rounded-2xl border border-zinc-200 bg-white px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-zinc-300"
              >
                {(me?.wards ?? []).map((w) => (
                  <option key={w.ward_id} value={w.ward_id}>
                    {w.primary_ward ? "‚≠ê Primary ward" : "Ward"} ‚Ä¢ {w.ward_id.slice(0, 8)}
                  </option>
                ))}
              </select>
              <div className="mt-1 text-[11px] text-zinc-500">* Ward mode ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏™‡πÄ‡∏ï‡πá‡∏õ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div>
            </div>
          )}

          {/* quick actions row */}
          <div className="mt-3 grid grid-cols-2 gap-2">
            <button
              onClick={() => {
                if (todayRow) openDetails(todayRow.shift_instance_id);
              }}
              className={cx(
                "rounded-2xl px-4 py-3 text-sm font-medium ring-1 ring-inset",
                todayRow ? "bg-zinc-900 text-white ring-zinc-900" : "bg-zinc-100 text-zinc-400 ring-zinc-200"
              )}
              disabled={!todayRow}
            >
              ‚úÖ Today
            </button>

            <button
              onClick={() => {
                document.getElementById("upcoming")?.scrollIntoView({ behavior: "smooth", block: "start" });
              }}
              className="rounded-2xl bg-white px-4 py-3 text-sm font-medium text-zinc-900 ring-1 ring-inset ring-zinc-200 hover:bg-zinc-50"
            >
              üìÖ Upcoming
            </button>
          </div>

          {err && (
            <div className="mt-3 rounded-2xl bg-rose-50 px-4 py-3 text-sm text-rose-700 ring-1 ring-rose-200">
              {err}
            </div>
          )}
        </div>
      </div>

      {/* Content (‡∏™‡∏Å‡∏£‡∏≠‡∏•‡∏•‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) */}
      <main className="flex-1 overflow-y-auto [-webkit-overflow-scrolling:touch]">
        <div className="mx-auto max-w-md px-5 py-5">
          {/* Today card */}
          <div className="rounded-3xl border border-zinc-200 bg-white p-4 shadow-sm">
            <div className="flex items-start justify-between gap-3">
              <div>
                <div className="text-sm text-zinc-500">Today</div>
                <div className="text-base font-semibold text-zinc-900">
                  {todayRow ? `${shiftLabel(todayRow)} ‚Ä¢ ${formatDateTH(todayRow.shift_date)}` : "No shift today"}
                </div>

                <div className="mt-1 text-sm text-zinc-600">
                  {todayRow
                    ? timeRange(todayRow.start_time, todayRow.end_time, todayRow.cross_midnight)
                    : upcoming?.[0]
                    ? `Next: ${formatDateTH(upcoming[0].shift_date)}`
                    : "‚Äî"}
                </div>

                {todayRow && mode === "my" && (
                  <div className="mt-1 text-xs text-zinc-500">My role: {roleChip(myRoleInShift(todayRow)) ?? "‚Äî"}</div>
                )}
              </div>

              <StatusBadge risk={Boolean(todayRow?.risk_flag)} />
            </div>

            <div className="mt-4">
              <button
                onClick={() => {
                  if (!todayRow) return;
                  openDetails(todayRow.shift_instance_id);
                }}
                className={cx(
                  "w-full rounded-2xl px-4 py-3 text-sm font-semibold ring-1 ring-inset",
                  todayRow ? "bg-white text-zinc-900 ring-zinc-200 hover:bg-zinc-50" : "bg-zinc-100 text-zinc-400 ring-zinc-200"
                )}
                disabled={!todayRow}
              >
                View details
              </button>
            </div>

            <div className="mt-3 text-xs text-zinc-500">
              * Confirm / Can‚Äôt make it: ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏£‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö leave_requests / response table ‡πÉ‡∏ô‡∏™‡πÄ‡∏ï‡πá‡∏õ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            </div>
          </div>

          {/* Upcoming list */}
          <div id="upcoming" className="mt-5">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-sm text-zinc-500">Schedule</div>
                <div className="text-base font-semibold text-zinc-900">
                  {mode === "my" ? "Upcoming (My)" : "Upcoming (Ward)"}
                </div>
              </div>
              <div className="text-xs text-zinc-500">Next 14 shifts</div>
            </div>

            {loading ? (
              <div className="mt-3 rounded-3xl border border-zinc-200 bg-white p-4 text-sm text-zinc-600 shadow-sm">
                Loading...
              </div>
            ) : upcoming.length === 0 ? (
              <div className="mt-3 rounded-3xl border border-zinc-200 bg-white p-4 text-sm text-zinc-600 shadow-sm">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
              </div>
            ) : (
              <div className="mt-3 space-y-2">
                {upcoming.map((r) => {
                  const meRole = mode === "my" ? myRoleInShift(r) : null;

                  return (
                    <button
                      key={r.shift_instance_id}
                      onClick={() => openDetails(r.shift_instance_id)}
                      className="w-full rounded-3xl border border-zinc-200 bg-white p-4 text-left shadow-sm hover:bg-zinc-50"
                    >
                      <div className="flex items-start justify-between gap-3">
                        <div className="min-w-0">
                          <div className="text-sm text-zinc-500">{formatDateTH(r.shift_date)}</div>
                          <div className="truncate text-base font-semibold text-zinc-900">
                            {shiftLabel(r)}{" "}
                            <span className="text-sm font-medium text-zinc-500">
                              ‚Ä¢ {timeRange(r.start_time, r.end_time, r.cross_midnight)}
                            </span>
                          </div>

                          {mode === "my" ? (
                            <div className="mt-1 text-sm text-zinc-600">My role: {roleChip(meRole) ?? "‚Äî"}</div>
                          ) : (
                            <div className="mt-1 text-sm text-zinc-600">Ward mode (coming soon)</div>
                          )}

                          {r.note && <div className="mt-2 text-xs text-zinc-500">Note: {r.note}</div>}
                        </div>

                        <div className="flex flex-col items-end gap-2">
                          <StatusBadge risk={Boolean(r.risk_flag)} />
                          {r.shift_code && (
                            <span className="rounded-full bg-zinc-100 px-2 py-0.5 text-xs text-zinc-700 ring-1 ring-inset ring-zinc-200">
                              {String(r.shift_code).toUpperCase()}
                            </span>
                          )}
                        </div>
                      </div>
                    </button>
                  );
                })}
              </div>
            )}
          </div>

          {/* ‡∏Å‡∏±‡∏ô‡∏ó‡πâ‡∏≤‡∏¢ list ‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô Bottom nav ‡∏ó‡∏±‡∏ö (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ safe-area ‡∏î‡πâ‡∏ß‡∏¢) */}
          <div style={{ height: "calc(92px + env(safe-area-inset-bottom))" }} />
        </div>
      </main>

      {/* Bottom nav (‡∏ô‡∏¥‡πà‡∏á + ‡πÑ‡∏°‡πà‡πÄ‡∏•‡πá‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ) */}
      <div className="flex-none border-t border-zinc-200 bg-white" style={{ paddingBottom: "env(safe-area-inset-bottom)" }}>
        <div className="mx-auto grid max-w-md grid-cols-4 gap-2 px-5 py-3">
          <button className="min-h-11 rounded-2xl bg-zinc-900 px-3 py-2.5 text-[13px] font-semibold text-white">
            üè† Home
          </button>

          <button
            className="min-h-11 rounded-2xl bg-white px-3 py-2.5 text-[13px] font-semibold text-zinc-900 ring-1 ring-inset ring-zinc-200 hover:bg-zinc-50"
            onClick={() => alert("Demo: Alerts")}
          >
            üîî Alerts
          </button>

          <button
            className="min-h-11 rounded-2xl bg-white px-3 py-2.5 text-[13px] font-semibold text-zinc-900 ring-1 ring-inset ring-zinc-200 hover:bg-zinc-50"
            onClick={() => alert("Demo: Me")}
          >
            üë§ Me
          </button>

          <button
            className="min-h-11 rounded-2xl bg-rose-50 px-3 py-2.5 text-[13px] font-semibold text-rose-700 ring-1 ring-inset ring-rose-200 hover:bg-rose-100"
            onClick={logout}
          >
            üö™ Logout
          </button>
        </div>
      </div>

      {/* Details sheet */}
      <BottomSheet
        open={sheetOpen}
        title="Shift details"
        onClose={() => {
          setSheetOpen(false);
          setActiveId(null);
        }}
      >
        {!active ? (
          <div className="text-sm text-zinc-600">No data</div>
        ) : (
          <div className="space-y-3">
            <div className="flex items-start justify-between gap-3">
              <div>
                <div className="text-xs text-zinc-500">{formatDateTH(active.shift_date)}</div>
                <div className="text-lg font-semibold text-zinc-900">{shiftLabel(active)}</div>
                <div className="text-sm text-zinc-600">
                  {timeRange(active.start_time, active.end_time, active.cross_midnight)}
                </div>
                {mode === "my" && (
                  <div className="mt-1 text-xs text-zinc-500">My role: {roleChip(myRoleInShift(active)) ?? "‚Äî"}</div>
                )}
                <div className="mt-1 text-xs text-zinc-500">Ward: {active.ward_id?.slice(0, 8) ?? "‚Äî"}</div>
              </div>
              <StatusBadge risk={Boolean(active.risk_flag)} />
            </div>

            {active.note && (
              <div className="rounded-2xl bg-zinc-50 p-3 ring-1 ring-inset ring-zinc-200">
                <div className="text-xs text-zinc-500">Note</div>
                <div className="text-sm text-zinc-900">{active.note}</div>
              </div>
            )}

            <div className="rounded-2xl bg-amber-50 p-3 ring-1 ring-inset ring-amber-200">
              <div className="text-sm font-semibold text-amber-900">Next step</div>
              <div className="mt-1 text-xs text-amber-800">
                ‡∏õ‡∏∏‡πà‡∏° Confirm / Can‚Äôt make it ‡∏à‡∏∞‡∏ï‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á leave_requests ‡∏´‡∏£‡∏∑‡∏≠ staff_shift_responses (‡∏ó‡∏≥‡πÉ‡∏´‡πâ scheduler ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ)
              </div>
            </div>

            <div className="text-[11px] text-zinc-500">
              * Demo ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ ‚ÄúMy shifts (Next 14 shifts)‚Äù ‡∏Å‡πà‡∏≠‡∏ô ‚Äî ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏∞ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ó‡∏≥ Ward endpoint ‡πÅ‡∏¢‡∏Å‡πÉ‡∏ô‡∏™‡πÄ‡∏ï‡πá‡∏õ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            </div>
          </div>
        )}
      </BottomSheet>
    </div>
  );
}
